#!/bin/bash -e

REPOSITORY="/root/repository"

function make_image_debian {
	DIST=$1
	ARCH=$2	
	
	pbuilder create \
		--distribution ${DIST} \
		--basetgz /var/cache/pbuilder/${DIST}-${ARCH}.tgz \
		--mirror ftp://ftp.nl.debian.org/debian/ \
		--othermirror "deb file:${REPOSITORY} ${DIST} main" \
		--bindmounts "${REPOSITORY}" \
		--debootstrap cdebootstrap \
		--debootstrapopts "--arch=${ARCH}" \
		--debootstrapopts "--allow-unauthenticated" \
		--debootstrapopts "--flavour=build" \
		--autocleanaptcache
}

function make_image_ubuntu {
	DIST=$1
	ARCH=$2	
	
	pbuilder create \
		--distribution ${DIST} \
		--basetgz /var/cache/pbuilder/${DIST}-${ARCH}.tgz \
		--mirror http://nl.archive.ubuntu.com/ubuntu/ \
		--othermirror "deb file:${REPOSITORY} ${DIST} main" \
		--bindmounts "${REPOSITORY}" \
		--debootstrap debootstrap \
		--debootstrapopts "--arch=${ARCH}" \
		--debootstrapopts "--variant=buildd" \
		--debootstrapopts "--verbose" \
		--autocleanaptcache

	# if this fails, you may need to create debootstrap symlinks for lucid and maverick:
	# ln -s /usr/share/debootstrap/scripts/gutsy /usr/share/debootstrap/scripts/maverick
	# ln -s /usr/share/debootstrap/scripts/gutsy /usr/share/debootstrap/scripts/lucid
}

if [ ! -f "${REPOSITORY}/conf/distributions" ]; then
	
	mkdir -p "${REPOSITORY}/conf"
	
	
	echo "# This file was initially generated by $0"	>  "${REPOSITORY}/conf/distributions"

	echo "Origin: OpenPanel"				 			>> "${REPOSITORY}/conf/distributions"
	echo "Label: OpenPanel" 							>> "${REPOSITORY}/conf/distributions"
	echo "Description: OpenPanel APT repository"		>> "${REPOSITORY}/conf/distributions"
	echo "DebIndices: Packages Release . .gz .bz2"		>> "${REPOSITORY}/conf/distributions"
	echo "DscIndices: Sources Release .gz .bz2"			>> "${REPOSITORY}/conf/distributions"
	echo "SignWith: 4EAC69B9"							>> "${REPOSITORY}/conf/distributions"
	
	for dist in lenny squeeze maverick lucid; do
		echo "Codename: ${dist}" 						>> "${REPOSITORY}/conf/distributions"
		echo "Architectures: amd64 i386 source" 		>> "${REPOSITORY}/conf/distributions"
		echo "Components: main"					 		>> "${REPOSITORY}/conf/distributions"
		echo "" 										>> "${REPOSITORY}/conf/distributions"
	done	

	# generate
	reprepro -b "${REPOSITORY}" export
fi

if [ ! -e "/usr/share/debootstrap/scripts/maverick" ]; then
	ln -s /usr/share/debootstrap/scripts/gutsy /usr/share/debootstrap/scripts/maverick
fi

if [ ! -e "/usr/share/debootstrap/scripts/lucid" ]; then
	ln -s /usr/share/debootstrap/scripts/gutsy /usr/share/debootstrap/scripts/lucid
fi

#make_image_ubuntu lucid    amd64
#make_image_ubuntu lucid    i386

#make_image_ubuntu maverick amd64
#make_image_ubuntu maverick i386

make_image_debian squeeze  amd64
make_image_debian squeeze  i386
make_image_debian lenny    amd64
make_image_debian lenny    i386


